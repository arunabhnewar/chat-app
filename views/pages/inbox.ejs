<%- include('../partials/header.ejs'); %>

<div id="chat-container">
  <div id="search-container">
    <input type="text" placeholder="Search" />
  </div>

  <div id="conversation-list">
    <% data.forEach(function(conversation) { %>
    <!-- conversation creator is same to logged in user, so we need to show participant name and avatar -->
    <% if(conversation.creator.id == loggedInUser.userid) { %>
    <div class="conversation" onclick="getMessages('<%= conversation._id %>', '<%= conversation.participant.name %>')">
      <% if (conversation.participant.avatar) { %>
      <img src="./uploads/avatars/<%= conversation.participant.avatar %>" alt="<%= conversation.participant.name %>" />
      <% } else { %>
      <img src="./assets/nophoto.png" />
      <% } %>
      <div class="title-text"><%= conversation.participant.name %></div>
      <div class="conversation-date">Apr 01</div>
    </div>
    <% } else { %>
    <div class="conversation" onclick="getMessages('<%= conversation._id %>', '<%= conversation.creator.name %>')">
      <% if (conversation.creator.avatar) { %>
      <img src="./uploads/avatars/<%= conversation.creator.avatar %>" alt="<%= conversation.creator.name %>" />
      <% } else { %>
      <img src="./assets/nophoto.png" />
      <% } %>
      <div class="title-text"><%= conversation.creator.name %></div>
      <div class="conversation-date">Apr 01</div>
    </div>
    <% } %>
    <% }); %>

    <!-- show no conversation placeholder image for 0 conversations -->
    <% if(data && data.length === 0) { %>
    <div class="nothing"><img src="./assets/no-conversation.svg"></div>
    <% } %>
  </div>

  <div class="new-message-container" onclick="openModal()">
    <a href="#">+</a>
  </div>

  <div id="chat-title">
    <span id="conversation-partner"></span>
    <img src="./assets/trash.png" alt="Delete Conversation" />
  </div>

  <!-- placeholder div if no messages are in messages area -->
  <div id="chat-message-list">
    <div class="nothing">select a conversation</div>
  </div>

  <!-- send message form -->
  <form id="chat-form" method="post" enctype="multipart/form-data">
    <label for="attachment"><img src="./assets/attachment.png" alt="Add Attachment" /></label>
    <input type="file" multiple name="attachment" class="hide" id="attachment" />
    <input type="text" name="message" placeholder="Type a message" autocomplete="off" />
  </form>

</div>

<%- include('../partials/add-conversation-modal.ejs')  %>

<!-- import socket io client from cdn -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.min.js"></script>

<script>
  const form = document.querySelector("#chat-form");
  let participant = null;       // selected conversation participant object
  let current_conversation_id;   // selected conversation id
  const loggedInUserId = "<%= loggedInUser.userid %>";
  const loggedInUserName = "<%= loggedInUser.username %>";


  // get messages of a conversation
  async function getMessages(conversation_id, current_conversation_name) {
    // messages failure toast
    const messagesFailureToast = Toastify({
      text: "Error loading messages!",
      duration: 1000,
    });

    let response = await fetch(`/inbox/messages/${conversation_id}`);
    const result = await response.json();

    if (!result.errors && result.data) {
      form.style.visibility = "visible";

      const { data, user, conversation_id } = result;
      participant = data.participant;
      current_conversation_id = conversation_id;

      if (data.messages) {
        let allMessages = "";

        if (data.messages.length > 0) {
          data.messages.forEach((message) => {

            let senderAvatar = message.sender.avatar ? `./uploads/avatars/${message.sender.avatar}` : "./assets/nophoto.png";
            const messageClass = message.sender.id === loggedInUserId ? 'you-message' : 'other-message';
            const showAvatar = message.sender.id === loggedInUserId ? "" : `<img src="${senderAvatar}" alt="${message.sender.name}" />`;


            // message attachments
            let attachments = '<div class="attachments">';

            if (message.attachment && message.attachment.length > 0) {
              message.attachment.forEach((attachment) => {
                attachments += `<img src="./uploads/attachments/${attachment}" />`;
              });
            }

            attachments += '</div>';

            // final html message
            let messageHTML = `
            <div class="message-row ${messageClass}">
              <div class="message-content">
                ${showAvatar}
                <div class="message-text">${message.text}</div>
                ${attachments}
                <div class="message-time">${moment(message.date_time).fromNow()}</div>
              </div>
            </div>`;

            allMessages += messageHTML;
            messageContainer.innerHTML = "<div class='message-row'></div>";
          });

        } else if (data.message.length === 0) {
          messageContainer.innerHTML = "<div class='message-row'></div>";
        }

        chatTitleContainer.textContent = current_conversation_name;
      };

    } else {
      messagesFailureToast.showToast();
    };
  };


</script>

</body>

</html>